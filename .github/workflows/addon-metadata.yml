name: Update Addon Metadata

on:
  push:
    branches:
      - main
    paths:
      - 'addon-windows/config.yaml'

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Extract Metadata and Update Files
        run: |
          # 1. Extract version from config.yaml
          VERSION=$(grep '^version:' addon-windows/config.yaml | head -1 | awk '{print $2}' | tr -d '"')
          DATE=$(date +'%d-%m-%Y')
          REPO="${{ github.repository }}"
          
          # 2. Create updater.json
          cat <<EOF > addon-windows/updater.json
          {
            "github_beta": "false",
            "last_update": "$DATE",
            "repository": "$REPO",
            "slug": "windows",
            "source": "github",
            "upstream_repo": "dockur/windows",
            "upstream_version": "$VERSION"
          }
          EOF

          # 3. Update CHANGELOG.md
          # Only append if this version isn't already the first line to avoid duplicates
          if ! grep -q "## $VERSION" addon-windows/CHANGELOG.md; then
            TEMP_CHANGELOG=$(mktemp)
            echo -e "## $VERSION ($DATE)\n\n- Updated to version $VERSION\n$(cat addon-windows/CHANGELOG.md)" > "$TEMP_CHANGELOG"
            mv "$TEMP_CHANGELOG" addon-windows/CHANGELOG.md
          fi

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update updater.json and CHANGELOG for v${{ env.VERSION }}"
          file_pattern: 'addon-windows/updater.json addon-windows/CHANGELOG.md'
